<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>รายละเอียดบิลค้างชำระ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {background: #fff;font-family: Arial,sans-serif;color: #222;margin: 0;padding: 0;}
        h1 { color: #0073ea;text-align: center;font-weight: bold;letter-spacing: 1px;margin: 32px 0 18px 0;font-size: 2em;}
        .main-container { max-width: 900px; background: #fff; margin: auto;}
        .form-top-row { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 16px; margin-bottom: 16px; font-size: 1.1em;}
        .form-top-row label { margin-right: 3px; font-weight: 500; }
        .form-top-row select, .form-top-row input[type="date"] {min-width: 110px;padding: 9px 12px;border-radius:8px; border:1px solid #bbb; outline:none; font-size:1em;}
        .dates-row { display: flex; justify-content: center; align-items: center; gap: 9px; margin-bottom: 18px;}
        .dates-row label { font-weight: 500; }
        .status-row {display: flex; justify-content: center; align-items: center; margin-bottom: 10px;}
        .status-row label {margin-right:6px; font-weight:500;}
        .status-row select {padding: 7px 14px; border-radius: 7px; border: 1px solid #bbb; font-size:1em; min-width:120px;}
        .det-row {text-align:center; margin:10px 0 14px 0;font-size:1.13em;font-weight:500;}
        .det-row strong {font-size:1.17em;color:#222;letter-spacing:1px;}
        .table-wrap {overflow-x:auto; margin-bottom:20px;}
        .custom-table {width:100%; border-collapse:collapse; box-shadow:0 2px 8px #eee; font-size: 1em; min-width: 690px;}
        .custom-table th {background:#0086ff;color:#fff;font-weight:bold;text-align:center;padding:12px 4px;border-bottom:3px solid #fff;}
        .custom-table td {text-align:center;padding:10px 4px;border-bottom:1px solid #e5e5e5;}
        .custom-table td input[type="checkbox"] {transform:scale(1.1);}
        .custom-table tr:last-child td {border-bottom:none;}
        .total-row {background:#eaf5ff;font-weight:bold;}
        .total-row td {font-size:1.2em;padding:15px 8px;text-align:right;}
        .total-label {text-align:left !important;}
        .centered-btn {width:97%;margin:auto;display:flex;justify-content:center;align-items:center;margin-bottom:24px;}
        .btn-gen {padding:13px 32px;background:#0073ea;color:#fff;border:none;border-radius:8px;font-size:1.1em;cursor:pointer;margin:14px 8px;font-weight:500;}
        .btn-gen:hover {background:#005dc0;}
        .img-area {display:flex;flex-direction:column;align-items:center;gap:40px;margin-top:15px;margin-bottom:35px;}
        .qr-img {margin-bottom:40px;}
        .barcode-img {margin-top:22px;margin-bottom:10px;}
        .debug-info {background: #f8f9fa;padding: 15px;border-radius: 8px;margin: 20px 0;font-family: monospace;font-size: 12px;border: 1px solid #dee2e6;}
        .loading {display: none;text-align: center;padding: 40px;}
        .loading-spinner {border: 4px solid #f3f3f3;border-top: 4px solid #0073ea;border-radius: 50%;width: 50px;height: 50px;animation: spin 1s linear infinite;margin: 0 auto 20px;}
        @keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}
        /* Responsive */
        @media (max-width: 640px) {
            .main-container {max-width: 100vw; padding: 0 2vw;}
            .form-top-row, .dates-row, .status-row {font-size: 0.99em; gap: 5px;}
            h1 { font-size: 1.18em;}
            .det-row { font-size: 0.99em;}
            .custom-table, .custom-table th, .custom-table td {font-size:0.91em;min-width:85px;}
        }
    </style>
</head>
<body>
<div class="main-container">
    <h1>WEB APP</h1>
    
    <div class="loading" id="loadingDiv">
        <div class="loading-spinner"></div>
        <p>กำลังโหลดข้อมูล...</p>
    </div>
    
    <div class="debug-info" id="debugInfo" style="display: none;">
        <strong>Debug Info:</strong><br>
        <div id="debugContent"></div>
    </div>
    
    <div id="mainContent" style="display: none;">
        <div class="form-top-row">
            <label for="company">บริษัท:</label>
            <select id="company"></select>
            <label for="cv">CV:</label>
            <select id="cv"></select>
            <label>ชื่อบัญชี:</label>
            <span id="account-label" style="font-weight:bold;padding-left:10px"></span>

            <div class="dates-row">
                <label for="start-date">วันที่เริ่ม:</label>
                <input type="date" id="start-date">
                <label for="end-date">ถึง</label>
                <input type="date" id="end-date">
            </div>
        </div>
        <div class="status-row">
            <label for="duedate-status">สถานะวันครบกำหนด:</label>
            <select id="duedate-status">
                <option value="all">ทั้งหมด</option>
                <option value="in">ภายในกำหนด</option>
                <option value="over">เกินกำหนด</option>
            </select>
        </div>
        <div class="det-row" id="bill-detail">
            รายละเอียดบิล : วันที่ <strong id="current-date"></strong>
        </div>
        <div class="table-wrap">
            <table class="custom-table" id="inv-table">
                <thead>
                <tr>
                    <th><input type="checkbox" id="check-all"></th>
                    <th>วันที่</th>
                    <th>ประเภทเอกสาร</th>
                    <th>เลขที่บิล</th>
                    <th>วันครบกำหนด</th>
                    <th>จำนวนเงิน</th>
                </tr>
                </thead>
                <tbody id="tb-body"></tbody>
                <tfoot>
                <tr class="total-row">
                    <td colspan="5" class="total-label">รวม:</td>
                    <td id="total-amount">0</td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="centered-btn">
            <button class="btn-gen" id="gen-btn">Generate เพื่อชำระเงิน</button>
        </div>
        <div class="img-area">
            <div id="qr-area" class="qr-img"></div>
            <div id="barcode-area" class="barcode-img"></div>
        </div>
    </div>
</div>

<script>
    let allInvoicesData;

    function populateDropdown(list, elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        let uniqueList = Array.from(new Set(list));
        el.innerHTML = uniqueList.filter(x => x && x.trim() !== '').map(x => `<option value="${x}">${x}</option>`).join('');
        if (el.options.length > 0) el.value = el.options[0].value;
    }

    function formatDate(dstr) {
        if (!dstr) return '-';
        let d = new Date(dstr);
        if (isNaN(d.getTime())) return dstr;
        return (d.getDate() + "/" + (d.getMonth()+1) + "/" + d.getFullYear());
    }

    function todayStr() {
        let t = new Date();
        return t.toISOString().substr(0,10);
    }

    function displayCurrentDate() {
        let t = new Date();
        const el = document.getElementById("current-date");
        if (el) el.innerText = `${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`;
    }

    function updateAccountDropdown() {
        const company = document.getElementById('company').value;
        const cv = document.getElementById('cv').value;
        
        const invoice = allInvoicesData.invoices.find(inv =>
            inv.company == company && inv.cv == cv
        );

        let accountName = '-';
        if (invoice && invoice.name) accountName = invoice.name;

        document.getElementById('account-label').innerText = accountName;
        renderTable();
    }

    function renderTable() {
        let tbody = document.getElementById("tb-body");
        if (!tbody || !allInvoicesData || !allInvoicesData.invoices || allInvoicesData.invoices.length === 0) {
            if (tbody) tbody.innerHTML = "<tr><td colspan='6'>ไม่มีข้อมูลที่ตรงกับเงื่อนไข</td></tr>";
            return;
        }

        let start = document.getElementById('start-date').value;
        let end = document.getElementById('end-date').value;
        let status = document.getElementById('duedate-status').value;
        let companyValue = document.getElementById('company').value;
        let cvValue = document.getElementById('cv').value;
        let accountValue = document.getElementById('account-label').innerText.trim();
        if (accountValue === '-' || !accountValue) accountValue = '';

        let filtered = allInvoicesData.invoices.filter(inv=>{
            let dateOk = true, statusOk = true, companyOk = true, cvOk = true, accountOk = true;

            if (start) dateOk = inv.date && (inv.date >= start);
            if (end)   dateOk = dateOk && inv.date && (inv.date <= end);
            
            let today = new Date();
            today.setHours(0,0,0,0);
            let invDue = inv.due ? new Date(inv.due) : null;
            
            if (status==="in") {
                statusOk = invDue && (invDue >= today);
            } else if (status==="over") {
                statusOk = invDue && (invDue < today);
            }
            
            if (companyValue) companyOk = (inv.company == companyValue);
            if (cvValue) cvOk = (inv.cv == cvValue);
            if (accountValue) accountOk = (inv.name == accountValue);
            
            return dateOk && statusOk && companyOk && cvOk && accountOk;
        });

        let html = "";
        filtered.forEach(inv => {
            html += `<tr>
                <td><input type="checkbox" class="check-item"></td>
                <td>${formatDate(inv.date)}</td>
                <td>${inv.docType || '-'}</td>
                <td>${inv.number || '-'}</td>
                <td>${formatDate(inv.due)}</td>
                <td>${(inv.amount || 0).toLocaleString()}</td>
            </tr>`;
        });
        
        tbody.innerHTML = html;
        bindCheckboxListeners();
        calculateTotal();
    }

    function bindCheckboxListeners() {
        var items = document.querySelectorAll('.check-item');
        if (items.length === 0) return;
        for(let i=0;i<items.length;i++){
            items[i].addEventListener('change', calculateTotal);
            items[i].checked = false;
        }
        document.getElementById('check-all').checked = false;
        document.getElementById('check-all').addEventListener('change',function(){
            var state = this.checked;
            items.forEach(cb=>cb.checked=state);
            calculateTotal();
        });
    }

    function calculateTotal() {
        var items = document.querySelectorAll('.check-item');
        var total = 0;
        items.forEach(function(cb) {
            if(cb.checked){
                var row = cb.closest('tr');
                if (row && row.cells && row.cells.length > 5) {
                    var amtStr = row.cells[5].innerText.replace(/,/g,"");
                    var amt = parseFloat(amtStr);
                    if (!isNaN(amt)) {
                        total += amt;
                    }
                }
            }
        });
        document.getElementById('total-amount').innerText = total.toLocaleString();
    }

    function getSelectedQRData() {
        const company = document.getElementById('company').value;
        const cv = document.getElementById('cv').value;
        const name = document.getElementById('account-label').innerText;
        const amount = document.getElementById('total-amount').innerText.replace(/,/g, '');

        const data = {
            company: company,
            cv: cv,
            name: name,
            amount: amount
        };

        console.log('QR Data:', data);
        return data;
    }

    function generateQRBarcode() {
        const qrdata = getSelectedQRData();
        
        // สำหรับ n8n เราจะใช้ external service สร้าง QR แทน
        const qrText = `Company: ${qrdata.company}, CV: ${qrdata.cv}, Name: ${qrdata.name}, Amount: ${qrdata.amount}`;
        const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?data=" + encodeURIComponent(qrText) + "&size=200x200";
        
        document.getElementById('qr-area').innerHTML = 
            '<div style="text-align:center;font-weight:bold; color:#0073ea; margin-bottom:3px;">' +
            qrdata.company + '<br>' + qrdata.name +
            '</div>' +
            '<img src="' + qrUrl + '" width="120" height="120" style="display:block;margin:auto;">' +
            '<div style="text-align:center; font-weight:bold; color:#222; margin-top:3px;">จำนวนเงิน ' + Number(qrdata.amount).toLocaleString() + ' บาท</div>';

        // สร้าง Barcode ง่ายๆ
        const barcodeText = `${qrdata.cv}|${qrdata.amount}`;
        const barcodeUrl = "https://bwipjs-api.metafloor.com/?bcid=code128&text=" + encodeURIComponent(barcodeText) + "&includetext&scale=1.4&height=12";
        
        document.getElementById('barcode-area').innerHTML =
            '<div style="text-align:center;font-weight:600;color:#0073ea;margin-bottom:2px; margin-top:-16px;">' +
            'Barcode สำหรับชำระเงิน' +
            '</div>' +
            '<img src="' + barcodeUrl + '" alt="barcode" style="display:block;margin:auto;">' +
            '<div style="text-align:center;color:#666;font-size:0.8em;margin-top:2px;">' +
            barcodeText +
            '</div>';
    }

    function showDebugInfo(data) {
        const debugDiv = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');
        
        debugContent.innerHTML = `
            URL: ${window.location.href}<br>
            Data found: ${data ? 'Yes' : 'No'}<br>
            Invoices: ${data?.invoices?.length || 0}<br>
            Companies: ${data?.companies?.length || 0}<br>
            CVs: ${data?.cvs?.length || 0}<br>
            Names: ${data?.names?.length || 0}
        `;
        
        // แสดง debug info ชั่วคราว
        debugDiv.style.display = 'block';
        setTimeout(() => {
            debugDiv.style.display = 'none';
        }, 5000);
    }

    function initializeData(data) {
        try {
            console.log('Initializing with data:', data);
            allInvoicesData = data;
            
            populateDropdown(allInvoicesData.companies, 'company');
            populateDropdown(allInvoicesData.cvs, 'cv');

            updateAccountDropdown();

            // ตั้งค่าวันที่เริ่มต้นและสิ้นสุด
            let validDates = allInvoicesData.invoices.filter(inv => inv.date && inv.date !== "1970-01-01");
            if (validDates.length > 0) {
                let minDate = validDates.reduce((min, inv) => inv.date < min ? inv.date : min, validDates[0].date);
                let maxDate = validDates.reduce((max, inv) => inv.date > max ? inv.date : max, validDates[0].date);
                
                const startDateEl = document.getElementById('start-date');
                if (startDateEl) startDateEl.value = minDate;
                const endDateEl = document.getElementById('end-date');
                if (endDateEl) endDateEl.value = maxDate;
            }

            // Bind event listeners
            const startDateEl = document.getElementById('start-date');
            if (startDateEl) startDateEl.addEventListener('change', renderTable);
            const endDateEl = document.getElementById('end-date');
            if (endDateEl) endDateEl.addEventListener('change', renderTable);
            const duedateStatusEl = document.getElementById('duedate-status');
            if (duedateStatusEl) duedateStatusEl.addEventListener('change', renderTable);
            const genBtnEl = document.getElementById('gen-btn');
            if (genBtnEl) genBtnEl.addEventListener('click', generateQRBarcode);
            const companyEl = document.getElementById('company');
            if (companyEl) companyEl.addEventListener('change', updateAccountDropdown);
            const cvEl = document.getElementById('cv');
            if (cvEl) cvEl.addEventListener('change', updateAccountDropdown);

            displayCurrentDate();
            renderTable();

            // แสดง main content และซ่อน loading
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

        } catch (e) {
            console.error("Error initializing data:", e);
            document.getElementById('loadingDiv').style.display = 'none';
            document.body.innerHTML = "<h1>เกิดข้อผิดพลาดในการโหลดข้อมูล</h1><p>ไม่สามารถโหลดข้อมูลได้: " + e.message + "</p>";
        }
    }

    function loadDataFromURL() {
        console.log('=== Loading data from URL ===');
        console.log('Current URL:', window.location.href);
        
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        
        console.log('Data parameter found:', dataParam ? 'Yes' : 'No');
        
        if (dataParam) {
            try {
                const data = JSON.parse(decodeURIComponent(dataParam));
                console.log('Parsed data:', data);
                
                showDebugInfo(data);
                
                if (data.invoices && Array.isArray(data.invoices)) {
                    initializeData(data);
                    return;
                } else {
                    console.error('No valid invoices array found in data');
                }
            } catch (e) {
                console.error('Error parsing URL data:', e);
                showDebugInfo(null);
            }
        } else {
            console.log('No data parameter in URL');
        }
        
        // แสดงข้อความไม่มีข้อมูล
        document.getElementById('loadingDiv').style.display = 'none';
        document.body.innerHTML = "<div class='main-container'><h1>WEB APP</h1><p style='text-align:center;margin-top:50px;'>ไม่พบข้อมูล กรุณาเข้าถึงผ่าน LINE Bot</p></div>";
    }

    // โหลดข้อมูลเมื่อหน้าเว็บพร้อม
    window.addEventListener('load', () => {
        console.log('Page loaded');
        loadDataFromURL();
    });
</script>
</body>
</html>
