<!DOCTYPE html>
<html lang="th">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>รายละเอียดบิลค้างชำระ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {background: #fff;font-family: Arial,sans-serif;color: #222;margin: 0;padding: 0;}
        h1 { color: #0073ea;text-align: center;font-weight: bold;letter-spacing: 1px;margin: 32px 0 18px 0;font-size: 2em;}
        .main-container { max-width: 900px; background: #fff; margin: auto;}
        .form-top-row { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 16px; margin-bottom: 16px; font-size: 1.1em;}
        .form-top-row label { margin-right: 3px; font-weight: 500; }
        .form-top-row select, .form-top-row input[type="date"] {min-width: 110px;padding: 9px 12px;border-radius:8px; border:1px solid #bbb; outline:none; font-size:1em;}
        .dates-row { display: flex; justify-content: center; align-items: center; gap: 9px; margin-bottom: 18px;}
        .dates-row label { font-weight: 500; }
        .status-row {display: flex; justify-content: center; align-items: center; margin-bottom: 10px;}
        .status-row label {margin-right:6px; font-weight:500;}
        .status-row select {padding: 7px 14px; border-radius: 7px; border: 1px solid #bbb; font-size:1em; min-width:120px;}
        .det-row {text-align:center; margin:10px 0 14px 0;font-size:1.13em;font-weight:500;}
        .det-row strong {font-size:1.17em;color:#222;letter-spacing:1px;}
        .table-wrap {overflow-x:auto; margin-bottom:20px;}
        .custom-table {width:100%; border-collapse:collapse; box-shadow:0 2px 8px #eee; font-size: 1em; min-width: 690px;}
        .custom-table th {background:#0086ff;color:#fff;font-weight:bold;text-align:center;padding:12px 4px;border-bottom:3px solid #fff;}
        .custom-table td {text-align:center;padding:10px 4px;border-bottom:1px solid #e5e5e5;}
        .custom-table td input[type="checkbox"] {transform:scale(1.1);}
        .custom-table tr:last-child td {border-bottom:none;}
        .total-row {background:#eaf5ff;font-weight:bold;}
        .total-row td {font-size:1.2em;padding:15px 8px;text-align:right;}
        .total-label {text-align:left !important;}
        .centered-btn {width:97%;margin:auto;display:flex;justify-content:center;align-items:center;margin-bottom:24px;}
        .btn-gen {padding:13px 32px;background:#0073ea;color:#fff;border:none;border-radius:8px;font-size:1.1em;cursor:pointer;margin:14px 8px;font-weight:500;}
        .btn-gen:hover {background:#005dc0;}
        .img-area {display:flex;flex-direction:column;align-items:center;gap:40px;margin-top:15px;margin-bottom:35px;}
        .qr-img {margin-bottom:40px;}
        .barcode-img {margin-top:22px;margin-bottom:10px;}
        .debug-info {background: #f8f9fa;padding: 15px;border-radius: 8px;margin: 20px 0;font-family: monospace;font-size: 12px;border: 1px solid #dee2e6;}
        .loading {text-align: center;padding: 40px;}
        .loading-spinner {border: 4px solid #f3f3f3;border-top: 4px solid #0073ea;border-radius: 50%;width: 50px;height: 50px;animation: spin 1s linear infinite;margin: 0 auto 20px;}
        .error-message {background: #f8d7da;color: #721c24;padding: 15px;border-radius: 8px;margin: 20px 0;border: 1px solid #f5c6cb;}
        .success-message {background: #d4edda;color: #155724;padding: 15px;border-radius: 8px;margin: 20px 0;border: 1px solid #c3e6cb;}
        @keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}
        /* Responsive */
        @media (max-width: 640px) {
            .main-container {max-width: 100vw; padding: 0 2vw;}
            .form-top-row, .dates-row, .status-row {font-size: 0.99em; gap: 5px;}
            h1 { font-size: 1.18em;}
            .det-row { font-size: 0.99em;}
            .custom-table, .custom-table th, .custom-table td {font-size:0.91em;min-width:85px;}
        }
    </style>
</head>
<body>
<div class="main-container">
    <h1>WEB APP - Thai QR Payment System</h1>
    
    <div class="loading" id="loadingDiv">
        <div class="loading-spinner"></div>
        <p>กำลังโหลดข้อมูล...</p>
    </div>
    
    <div class="debug-info" id="debugInfo" style="display: none;">
        <strong>Debug Info:</strong><br>
        <div id="debugContent"></div>
    </div>
    
    <div id="mainContent" style="display: none;">
        <div class="form-top-row">
            <label for="company">บริษัท:</label>
            <select id="company"></select>
            <label for="cv">CV:</label>
            <select id="cv"></select>
            <label>ชื่อบัญชี:</label>
            <span id="account-label" style="font-weight:bold;padding-left:10px"></span>

            <div class="dates-row">
                <label for="start-date">วันที่เริ่ม:</label>
                <input type="date" id="start-date">
                <label for="end-date">ถึง</label>
                <input type="date" id="end-date">
            </div>
        </div>
        <div class="status-row">
            <label for="duedate-status">สถานะวันครบกำหนด:</label>
            <select id="duedate-status">
                <option value="all">ทั้งหมด</option>
                <option value="in">ภายในกำหนด</option>
                <option value="over">เกินกำหนด</option>
            </select>
        </div>
        <div class="det-row" id="bill-detail">
            รายละเอียดบิล : วันที่ <strong id="current-date"></strong>
        </div>
        <div class="table-wrap">
            <table class="custom-table" id="inv-table">
                <thead>
                <tr>
                    <th><input type="checkbox" id="check-all"></th>
                    <th>วันที่</th>
                    <th>ประเภทเอกสาร</th>
                    <th>เลขที่บิล</th>
                    <th>วันครบกำหนด</th>
                    <th>จำนวนเงิน</th>
                </tr>
                </thead>
                <tbody id="tb-body"></tbody>
                <tfoot>
                <tr class="total-row">
                    <td colspan="5" class="total-label">รวม:</td>
                    <td id="total-amount">0</td>
                </tr>
                </tfoot>
            </table>
        </div>
        <div class="centered-btn">
            <button class="btn-gen" id="gen-btn">Generate Thai QR & Barcode เพื่อชำระเงิน</button>
        </div>
        
        <div id="message-area"></div>
        
        <div class="img-area">
            <div id="qr-area" class="qr-img"></div>
            <div id="barcode-area" class="barcode-img"></div>
        </div>
    </div>
</div>

<script>
    let allInvoicesData;
    let n8nBaseUrl = '';

    function populateDropdown(list, elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        let uniqueList = Array.from(new Set(list));
        el.innerHTML = uniqueList.filter(x => x && x.trim() !== '').map(x => `<option value="${x}">${x}</option>`).join('');
        if (el.options.length > 0) el.value = el.options[0].value;
    }

    function formatDate(dstr) {
        if (!dstr) return '-';
        let d = new Date(dstr);
        if (isNaN(d.getTime())) return dstr;
        return (d.getDate() + "/" + (d.getMonth()+1) + "/" + d.getFullYear());
    }

    function displayCurrentDate() {
        let t = new Date();
        const el = document.getElementById("current-date");
        if (el) el.innerText = `${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`;
    }

    function showMessage(message, type = 'success') {
        const messageArea = document.getElementById('message-area');
        const className = type === 'error' ? 'error-message' : 'success-message';
        messageArea.innerHTML = `<div class="${className}">${message}</div>`;
        
        setTimeout(() => {
            messageArea.innerHTML = '';
        }, 5000);
    }

    function updateAccountDropdown() {
        const company = document.getElementById('company').value;
        const cv = document.getElementById('cv').value;
        
    console.log('Looking for:', company, cv);
    console.log('Available invoices:', allInvoicesData.invoices);


    const invoice = allInvoicesData.invoices.find(inv => {
        console.log('Checking:', inv.company, inv.cv, 'vs', company, cv);
        return inv.company == company && inv.cv == cv;
    });
    
    console.log('Found invoice:', invoice);

        let accountName = '-';
        if (invoice && invoice.name) accountName = invoice.name;

        document.getElementById('account-label').innerText = accountName;
        renderTable();
    }

    function renderTable() {
        let tbody = document.getElementById("tb-body");
        if (!tbody || !allInvoicesData || !allInvoicesData.invoices || allInvoicesData.invoices.length === 0) {
            if (tbody) tbody.innerHTML = "<tr><td colspan='6'>ไม่มีข้อมูลที่ตรงกับเงื่อนไข</td></tr>";
            return;
        let companyValue = document.getElementById('company').value;
        let cvValue = document.getElementById('cv').value;
        let accountValue = document.getElementById('account-label').innerText.trim();
    
    console.log('Filter criteria:');
    console.log('companyValue:', companyValue);
    console.log('cvValue:', cvValue);
    console.log('accountValue:', accountValue);
    
    let filtered = allInvoicesData.invoices.filter(inv=>{
        console.log('Checking invoice:', inv.company, inv.cv, inv.name);
        // ... ส่วนที่เหลือ
    });
    
    console.log('Filtered results:', filtered.length);
        }

        let start = document.getElementById('start-date').value;
        let end = document.getElementById('end-date').value;
        let status = document.getElementById('duedate-status').value;
        let companyValue = document.getElementById('company').value;
        let cvValue = document.getElementById('cv').value;
        let accountValue = document.getElementById('account-label').innerText.trim();
        if (accountValue === '-' || !accountValue) accountValue = '';

        let filtered = allInvoicesData.invoices.filter(inv=>{
            let dateOk = true, statusOk = true, companyOk = true, cvOk = true, accountOk = true;

            if (start) dateOk = inv.date && (inv.date >= start);
            if (end)   dateOk = dateOk && inv.date && (inv.date <= end);
            
            let today = new Date();
            today.setHours(0,0,0,0);
            let invDue = inv.due ? new Date(inv.due) : null;
            
            if (status==="in") {
                statusOk = invDue && (invDue >= today);
            } else if (status==="over") {
                statusOk = invDue && (invDue < today);
            }
            
            if (companyValue) companyOk = (inv.company == companyValue);
            if (cvValue) cvOk = (inv.cv == cvValue);
            if (accountValue) accountOk = (inv.name == accountValue);
            
            // return dateOk && statusOk && companyOk && cvOk && accountOk;
            return dateOk && statusOk && companyOk && cvOk; // ไม่เช็ค accountOk
        });

        let html = "";
        filtered.forEach(inv => {
            html += `<tr>
                <td><input type="checkbox" class="check-item"></td>
                <td>${formatDate(inv.date)}</td>
                <td>${inv.docType || '-'}</td>
                <td>${inv.number || '-'}</td>
                <td>${formatDate(inv.due)}</td>
                <td>${(inv.amount || 0).toLocaleString()}</td>
            </tr>`;
        });
        
        tbody.innerHTML = html;
        bindCheckboxListeners();
        calculateTotal();
    }

    function bindCheckboxListeners() {
        var items = document.querySelectorAll('.check-item');
        if (items.length === 0) return;
        for(let i=0;i<items.length;i++){
            items[i].addEventListener('change', calculateTotal);
            items[i].checked = false;
        }
        document.getElementById('check-all').checked = false;
        document.getElementById('check-all').addEventListener('change',function(){
            var state = this.checked;
            items.forEach(cb=>cb.checked=state);
            calculateTotal();
        });
    }

    function calculateTotal() {
        var items = document.querySelectorAll('.check-item');
        var total = 0;
        items.forEach(function(cb) {
            if(cb.checked){
                var row = cb.closest('tr');
                if (row && row.cells && row.cells.length > 5) {
                    var amtStr = row.cells[5].innerText.replace(/,/g,"");
                    var amt = parseFloat(amtStr);
                    // if (!isNaN(amt)) {
                    //     total += Math.abs(amt); // ใช้ Math.abs() เพื่อแปลงเป็นค่าบวก
                    if (!isNaN(amt)) {
                        total += amt; // ลบ Math.abs() ออก
                    }
                }
            }
        });
        document.getElementById('total-amount').innerText = total.toLocaleString();
    }

    function getSelectedQRData() {
        const company = document.getElementById('company').value;
        const cv = document.getElementById('cv').value;
        const name = document.getElementById('account-label').innerText;
        const amount = document.getElementById('total-amount').innerText.replace(/,/g, '');

        return {
            company: company,
            cv: cv,
            name: name,
            amount: amount
        };
    }

    // ฟังก์ชันเรียก Flow 2 สำหรับสร้าง Thai QR และ Barcode
    async function generateThaiQRBarcode() {
        const qrdata = getSelectedQRData();
        
        if (!qrdata.amount || parseFloat(qrdata.amount) <= 0) {
            showMessage('กรุณาเลือกรายการที่ต้องการชำระเงิน', 'error');
            return;
        }

        const genBtn = document.getElementById('gen-btn');
        const originalText = genBtn.innerText;
        genBtn.disabled = true;
        genBtn.innerText = 'กำลังสร้าง QR & Barcode...';

        try {
            const response = await fetch(`${n8nBaseUrl}/webhook/qr-barcode`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(qrdata)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                // แสดง Thai QR Code
                document.getElementById('qr-area').innerHTML = 
                    '<div style="text-align:center;font-weight:bold; color:#0073ea; margin-bottom:8px;">' +
                    `${result.qr.companyName || qrdata.company}<br>${qrdata.name}` +
                    '</div>' +
                    '<div style="text-align:center;font-weight:600;color:#0073ea;margin-bottom:5px;">' +
                    'Thai PromptPay QR (ประเทศไทย)' +
                    '</div>' +
                    `<img src="${result.qr.imgUrl}" width="200" height="200" style="display:block;margin:auto;border:2px solid #0073ea;">` +
                    '<div style="text-align:center; font-weight:bold; color:#222; margin-top:8px;">จำนวนเงิน ' + 
                    Number(qrdata.amount).toLocaleString() + ' บาท</div>';

                // แสดง Thai Barcode
                document.getElementById('barcode-area').innerHTML =
                    '<div style="text-align:center;font-weight:600;color:#0073ea;margin-bottom:5px;">' +
                    'Thai Barcode สำหรับชำระเงิน' +
                    '</div>' +
                    `<img src="${result.barcode.barcodeImgUrl}" alt="barcode" style="display:block;margin:auto;max-width:100%;">` +
                    '<div style="text-align:center;color:#666;font-size:11px;margin-top:5px;word-break:break-all;">' +
                    result.barcode.barcodeString.replace(/\r/g, '[CR]') +
                    '</div>';

                showMessage('สร้าง Thai QR และ Barcode สำเร็จ!', 'success');
            } else {
                throw new Error(result.error || 'Unknown error occurred');
            }

        } catch (error) {
            console.error('Error generating QR/Barcode:', error);
            showMessage(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
        } finally {
            genBtn.disabled = false;
            genBtn.innerText = originalText;
        }
    }

    // ฟังก์ชันเรียก Flow 3 เพื่อดึงข้อมูล
    async function loadDataFromAPI(userId, n8nUrl) {
        try {
            console.log('Loading data from API:', n8nUrl + '/webhook/get-data');
            
            const response = await fetch(n8nUrl + '/webhook/get-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('API Response:', data);

            if (data.success) {
                return data;
            } else {
                throw new Error(data.error || 'API returned error');
            }

        } catch (error) {
            console.error('Error loading data from API:', error);
            throw error;
        }
    }
    //:ซ่อน showDebug
    function showDebugInfo(userId, n8nUrl, dataCount = 0) {
        // const debugDiv = document.getElementById('debugInfo');
        // const debugContent = document.getElementById('debugContent');
        
        // debugContent.innerHTML = `
        //     URL: ${window.location.href}<br>
        //     User ID: ${userId || 'Not found'}<br>
        //     N8N URL: ${n8nUrl || 'Not found'}<br>
        //     Data Count: ${dataCount}<br>
        //     API Endpoint: ${n8nUrl}/webhook/get-data
        // `;
        
        // debugDiv.style.display = 'block';
        // setTimeout(() => {
        //     debugDiv.style.display = 'none';
        // }, 7000);
    }

    function initializeData(data) {
        try {
            console.log('Initializing with data:', data);
            allInvoicesData = data;
            
            populateDropdown(allInvoicesData.companies, 'company');
            populateDropdown(allInvoicesData.cvs, 'cv');

            updateAccountDropdown();

            // ตั้งค่าวันที่
            let validDates = allInvoicesData.invoices.filter(inv => inv.date && inv.date !== "1970-01-01");
            if (validDates.length > 0) {
                let minDate = validDates.reduce((min, inv) => inv.date < min ? inv.date : min, validDates[0].date);
                let maxDate = validDates.reduce((max, inv) => inv.date > max ? inv.date : max, validDates[0].date);
                
                document.getElementById('start-date').value = minDate;
                document.getElementById('end-date').value = maxDate;
            }

            // Event listeners
            document.getElementById('start-date').addEventListener('change', renderTable);
            document.getElementById('end-date').addEventListener('change', renderTable);
            document.getElementById('duedate-status').addEventListener('change', renderTable);
            document.getElementById('gen-btn').addEventListener('click', generateThaiQRBarcode);
            document.getElementById('company').addEventListener('change', updateAccountDropdown);
            document.getElementById('cv').addEventListener('change', updateAccountDropdown);

            displayCurrentDate();
            renderTable();

            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

        } catch (e) {
            console.error("Error initializing data:", e);
            document.getElementById('loadingDiv').style.display = 'none';
            document.body.innerHTML = "<h1>เกิดข้อผิดพลาดในการโหลดข้อมูล</h1><p>" + e.message + "</p>";
        }
    }

    // โหลดข้อมูลจาก URL parameters และเรียก API
    async function loadDataFromURL() {
        console.log('=== Loading data from URL ===');
        
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const n8nUrl = urlParams.get('n8nUrl');
        
        console.log('userId:', userId);
        console.log('n8nUrl:', n8nUrl);
        
        if (!userId || !n8nUrl) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.body.innerHTML = "<div class='main-container'><h1>WEB APP</h1><p style='text-align:center;margin-top:50px;'>ไม่พบข้อมูล userId หรือ n8nUrl</p></div>";
            return;
        }

        n8nBaseUrl = n8nUrl;
        showDebugInfo(userId, n8nUrl);

        try {
            const data = await loadDataFromAPI(userId, n8nUrl);
            showDebugInfo(userId, n8nUrl, data.dataCount);
            initializeData(data);
        } catch (error) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.body.innerHTML = `<div class='main-container'><h1>เกิดข้อผิดพลาด</h1><p style='text-align:center;margin-top:50px;'>ไม่สามารถโหลดข้อมูลได้: ${error.message}</p></div>`;
        }
    }

    window.addEventListener('load', () => {
        console.log('Page loaded');
        loadDataFromURL();
    });
</script>
</body>
</html>
